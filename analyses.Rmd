---
title: "Explorative Analyses"
author: "Claudio Zanettini"
date:  "`r Sys.time()`"
output: 
  html_document:
    df_print: kable
    toc: true
    theme: journal
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
   # comment = "#>", 
   echo = FALSE,
   warning = FALSE,
   message=FALSE,
   fig.align = "center"
)
```   

```{r  message=FALSE}
library(here)
library(tidyverse)
library(readxl)
library(stringr)
library(janitor)
library(DT)
library(vroom)
library(lubridate)
library(ggcorrplot)
library(broom)
library(skimr)
library(nnet)
library(stargazer)

theme_set(theme_bw())
```

```{r functions}
# thank you slackoverflow
# https://stackoverflow.com/questions/47886409/r-is-there-a-function-to-clean-factor-levels-characters-columnwise-in-a-data-f
# #' 'Clean' a character/factor vector like `janitor::clean_names()` does for data frame columns
# #'
# #' Most of the internals are from `janitor::clean_names()`
# #'
# #' @param x a vector of strings or factors
# #' @param refactor if `x` is a factor, return a ref-factored factor?
# #'        Default: `FALSE` == return character vector.
clean_vec <- function (x, refactor=FALSE) {

  require(magrittr, quietly=TRUE)

  if (!(is.character(x) || is.factor(x))) return(x)

  x_is_factor <- is.factor(x)

  old_names <- as.character(x)

  new_names <- old_names %>%
    gsub("'", "", .) %>%
    gsub("\"", "", .) %>%
    gsub("%", "percent", .) %>%
    gsub("^[ ]+", "", .) %>%
    make.names(.) %>%
    gsub("[.]+", "_", .) %>%
    gsub("[_]+", "_", .) %>%
    tolower(.) %>%
    gsub("_$", "", .)


  if (x_is_factor && refactor) factor(new_names) else new_names

}
```



```{r import_clean}
dat_fr <- vroom(here("data", "clean_dataset.csv"), 
    col_names = c(
       "data_visita",
        "anno_visita",
       "luogo_visita",
       "sesso",
       "gemellarita",
       "ddn",
        "fascia_eta_gestazionale",
       "fascia_eta_visita",
       "eta_madre_parto",
       "inviati",
       "tipo_fecondazione",
       "situazione_presenatione",
       "tipo_parto_amb", # not unique
       "tipo_parto", # use this
       "n_gravidanze",
       "CC" ,
       "peso",
       "lunghezza",
       "apgar_1",
       "apgar_5",
       "allattamento",
       "codice_mdc_1",
       "mdc_1",
       "codice_mdc_2",
       "mdc_2",
       "codice_mdc_3",
       "mdc_3",
       "codice_mdc_4",
       "mdc_4",
       "n_trattamenti"
  ),
  skip = 1
)
                
                
dat_clean <- dat_fr %>% 
  mutate(across(where(is.character), ~ clean_vec(.x))) %>% 
  mutate(across(where(is.character), ~na_if(.x, "sconosciuto"))) %>% # sconosciuto = NA, mortacci
  mutate(across(where(is.character),  as.factor)) %>%
# recode that col that has crazy names, mortacci Davide, potevi pulirla
 mutate(mdc_full = mdc_1,
    mdc_1 = recode(mdc_1,
             "dismorfismi_cranio_facciali" = "dismorfismi_cf",
             "torcicolli_posturali_che_cmt_api"  = "torcicolli_posturali",
             "ritardi_e_alterazioni_del_neurosviluppo"   = "ritardi_alt_neuros",
             "disturbi_della_deambulazione" = "deambulazione",
             "piedi_torti_posturali_che_ccf" = "piedi_torti",
             "piedi_piatti_o_cavi" = "piedi_piatti_cavi",
             "altro_dolori_articolari_diffusi_dismorfismi_dita_prematurità_postumi_di_intervento_scialorrea" = "altro_dolori",
             "alterazioni_del_tono_muscolare" = "alterazioni_tono_muscolare",
             "difficoltà_alla_suzione" = "suzione"
            )) %>% 
  mutate(eta_paziente = floor(as.numeric(as.duration(data_visita - ddn), "months"))) %>% 
 
  # negative age? 
  filter(eta_paziente > 0) %>% 
  
  # drop NA mdc1
  
  drop_na(mdc_1) 


```


```{r}
skim(dat_clean)
```

# Descrizione Variabili

Non so qui che bisogna mettere.

# Sogetti

Nel corso di 3 anni (2017-2019), il nostro studio ha registrato informazioni riguardanti il trattamento osteopatico di 1288 pazienti, di cui il 58% (745) di sesso maschile. L'età dei soggetti é compresa tra un  1 mese e i 16 anni, con 76% (979) dei pazienti di età non superiore all'anno di vita (fig.1). 

46% parto cesareo e 42 vaginale, 12% vaginale operativo.

13 fecondazione assistita resto naturale.



<!-- 
https://www.cdc.gov/nchs/fastats/delivery.htm  
https://www.epicentro.iss.it/percorso-nascita/spinelli

Circa il 32 percento di gravidanze in U.S e' cesarea, 33% in italia

Percio nel vostro campioni i cesarei sono iperrappresentati. Questo puo' essere un caso o dipendere da altri fattori sottesi....parto piu difficoltoso.

Guarda peso bambino che e' nato da cesareo vs normale

 -->
 



```{r eta_min_max, eval=FALSE}
c(min(dat_clean$eta_paziente), max(dat_clean$eta_paziente)/12)
```

```{r sesso_parto, eval = FALSE}
dat_clean %>% 
  group_by(sesso) %>% 
  summarize(n = n()) %>%
  pivot_wider(names_from = "sesso", values_from = "n") %>% 
  mutate(ratio = m/(f + m))


dat_clean %>% 
  group_by(tipo_fecondazione) %>% 
  summarize(n = n()) %>% 
  na.omit() %>% 
  pivot_wider(names_from = "tipo_fecondazione", values_from = "n") %>% 
  mutate(ratio = naturale/(assistita + naturale))


dat_clean %>% 
  group_by(tipo_parto) %>% 
  summarize(n = n()) %>% 
  na.omit() %>% 
  pivot_wider(names_from = "tipo_parto", values_from = "n") %>% 
  mutate(ratio = naturale/(assistita + naturale))

```




```{r plot_eta_sesso}
dat_clean %>% 
  mutate(eta_paziente = floor(eta_paziente/12)) %>% 
  group_by(sesso) %>% 
  mutate(tot_sesso = n()) %>% 
  group_by(sesso, eta_paziente) %>% 
  summarize(n = n(),
            perc = n/first(tot_sesso) * 100,
            
            .groups = "drop_last") %>% 
  
  ggplot(aes(eta_paziente, perc, fill = sesso)) +
    geom_col() +
    facet_grid(vars(sesso)) +
    scale_y_continuous(labels = scales::label_percent(scale = 1)) +
    scale_fill_discrete(labels = c( "f" = "femmina", "m" = "maschio")) +
    labs(title = "Distribuzione pazienti per sesso ed età",
         caption = "fig.1",
         y = NULL,
         x = "età (anni)"
         )
    
```


```{r eta_tot, eval=FALSE}
dat_clean %>% 
  mutate(eta_paziente = floor(eta_paziente/12)) %>% 
  mutate(tot = n()) %>% 
  group_by(eta_paziente) %>% 
  summarize(n = n(),
            perc = n/first(tot) * 100,
            
            .groups = "drop_last")
```

```{r tipi_parto}
dat_clean %>% 
  drop_na(tipo_parto) %>% 
  mutate(tot = nrow(.)) %>% 
  group_by(tipo_parto) %>% 
  summarize(n = n(), perc = n/first(tot) * 100) %>% 
  # pivot_wider(names_from = "tipo_parto", values_from = "n") %>% 
  # mutate(tot = sum(.)) %>% 
  # mutate(across(everything(), ~.x / tot * 100, .names = "perc_{col}")) %>% 
  # select(starts_with("perc"), - perc_tot) %>% 
  # pivot_longer(cols = everything()) 
  ggplot(aes(tipo_parto, perc)) +
    geom_col() +
    scale_y_continuous(labels = scales::label_percent(scale = 1)) +
    scale_x_discrete(labels = c("vaginale_operativo" = "vaginale operativo")) +
    labs(y = NULL,
         x = NULL,
         title = "Tipo di parto",
         caption = "fig.2") 
```

```{r peso_tipo}
dat_clean %>% 
  drop_na(tipo_parto) %>% 
  group_by(tipo_parto) %>% 
  summarize(peso_medio = mean(peso/1000, na.rm = TRUE), peso_sd = sd((peso/1000), na.rm = TRUE)) %>% 
  ggplot(aes(tipo_parto, peso_medio)) +
    geom_col() +
    geom_linerange(aes(ymin = peso_medio + peso_sd, ymax = peso_medio - peso_sd)) +
    # facet_grid(vars(tipo_parto)) +
    # scale_y_continuous(labels = scales::label_percent(scale = 1)) +
    # scale_x_discrete(labels = c("vaginale_operativo" = "vaginale operativo")) +
    labs(y = "peso +/- Deviazione Standard (kg)",
         x = NULL,
         title = "Peso per tipo di parto") 

```


```{r tipi_fecondazione}
dat_clean %>% 
  drop_na(tipo_fecondazione) %>% 
  mutate(tot = nrow(.)) %>% 
  group_by(tipo_fecondazione) %>% 
  summarize(n = n(), perc = n/first(tot) * 100) 
```



```{r perc_mdc_1}
dat_clean %>% 
  mutate(tot = n()) %>% 
  group_by(mdc_1) %>% 
  summarize(n = n(),  tot  = first(tot), perc_mdc_1 = round(n/first(tot) * 100, 1)) %>% 
  arrange(desc(perc_mdc_1)) 

 #  
 #  
 #  ggplot(aes(reorder(mdc_1, perc_mdc_1), n)) +
 #      geom_col() +
 #  labs(
 #    x = "motivo di consulto",
 #    y =
 #  ) +
 # theme(axis.text.x = element_text(angle = 45,  hjust = 1))
```
 
# Correlazioni

```{r corr, fig.height=9, fig.width=9}
dat_clean %>% 
  select(where(is.numeric)) %>% 
    cor(use = "pairwise.complete.obs") %>%
    ggcorrplot(hc.order = TRUE, tl.cex = 8, lab = TRUE, lab_size = 3) 
```




<!-- https://dss.princeton.edu/training/LogitR101.pdf -->
<!-- https://stats.idre.ucla.edu/r/dae/multinomial-logistic-regression/ -->

```{r results ='asis', message=FALSE}
m1 <- dat_clean %>%
#   filter(codice_mdc_1 %in% !! unlist(to_filter)) %>% 
#   mutate(mdc_1 = droplevels(mdc_1)) %>% 
#   select(mdc_1 , sesso, tipo_di_parto, eta_della_madre_al_momento_del_parto) %>%
#   na.omit() %>%
# 
#   multinom(mdc_1   ~   ., dat = . )
# 
# m1_rr = exp(coef(m1))
# 
# stargazer(m1, type="html", coef=list(m1_rr), p.auto=FALSE)
```































